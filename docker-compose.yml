
services:
  vivaldi-hybrid-startpage:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - ai-api
      - storage-api
      - stt-api
      - image-search-api
      - gmail-api
      - notes-api
    volumes:
      - ./src:/app/src:ro
      - ./public:/app/public:ro
    restart: unless-stopped
    container_name: vivaldi-hybrid-startpage

  storage-api:
    image: node:18-alpine
    working_dir: /app
    command: node server/storage-server.mjs
    environment:
      - PORT=3100
      - ICONS_DIR=/app/uploads/icons
      - BACKGROUNDS_DIR=/app/uploads/backgrounds
    ports:
      - "3100:3100"
    volumes:
      - ./server:/app/server:ro
      - ./uploads:/app/uploads
    restart: unless-stopped
    container_name: vivaldi-storage-api
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3100/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  ai-api:
    image: node:18-alpine
    working_dir: /app
    command: node server/ai-server.mjs
    environment:
      - AI_PORT=3200
      - DATA_DIR=/app/uploads/ai
    ports:
      - "3200:3200"
    volumes:
      - ./server:/app/server:ro
      - ./uploads:/app/uploads
    restart: unless-stopped
    container_name: vivaldi-ai-api
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3200/ai/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  image-search-api:
    image: node:18-alpine
    working_dir: /app
    command: sh -c "npm install form-data@^4.0.1 --save && node server/image-search-server.mjs"
    environment:
      - IMAGE_SEARCH_PORT=3300
      - IMGBB_API_KEY=${IMGBB_API_KEY:-}
    ports:
      - "3300:3300"
    volumes:
      - ./server:/app/server:ro
    restart: unless-stopped
    container_name: vivaldi-image-search-api
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3300/image-search/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  gmail-api:
    image: node:18-alpine
    working_dir: /app
    command: node server/gmail-server.mjs
    environment:
      - GMAIL_PORT=3500
      - GMAIL_DATA_DIR=/app/uploads/gmail
      - GMAIL_CLIENT_ID=${GMAIL_CLIENT_ID:-}
      - GMAIL_CLIENT_SECRET=${GMAIL_CLIENT_SECRET:-}
    ports:
      - "3500:3500"
    volumes:
      - ./server:/app/server:ro
      - ./uploads:/app/uploads
    restart: unless-stopped
    container_name: vivaldi-gmail-api
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3500/gmail/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  notes-api:
    image: node:18-alpine
    working_dir: /app
    command: node server/notes-server.mjs
    environment:
      - NOTES_PORT=3400
      - NOTES_ROOT=/app/uploads/notes
    ports:
      - "3400:3400"
    volumes:
      - ./server:/app/server:ro
      - ./uploads:/app/uploads
    restart: unless-stopped
    container_name: vivaldi-notes-api
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:3400/notes/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Local STT service (Whisper ASR webservice)
  stt-api:
    image: onerahmet/openai-whisper-asr-webservice:latest
    environment:
      - ASR_MODEL=small
      - ASR_ENGINE=faster_whisper
      - NUM_WORKERS=1
    ports:
      - "8090:9000"
    restart: unless-stopped
    container_name: vivaldi-stt-api

  tts-api:
    profiles: ["tts"]
    image: ghcr.io/coqui-ai/tts:latest
    command: tts-server --port 5002 --model_name "tts_models/en/ljspeech/tacotron2-DDC" --use_cuda False
    environment:
      - COQUI_TOS_AGREED=1
    ports:
      - "8088:5002"
    restart: unless-stopped
    container_name: vivaldi-tts-api

  # No bundled SearXNG; app proxies to host SearXNG at host.docker.internal:8888

networks:
  default:
    name: vivaldi-network
