events {
    worker_connections 1024;
}

    http {
    # Normalize STT language param: drop when 'auto'
    map $arg_language $stt_lang_param {
        default "&language=$arg_language";
        ""        "";
        auto       "";
    }
    resolver 127.0.0.11 1.1.1.1 8.8.8.8 ipv6=off;
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

    server {
        listen 3000;
        server_name localhost;

        root /usr/share/nginx/html;
        index index.html;

        # Proxy SearXNG API for inline mode (avoid CORS)
        # Points to host's SearXNG at localhost:8888 (OrbStack/Docker for Mac supports host.docker.internal)
        location /searxng/ {
            proxy_pass http://host.docker.internal:8888/;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Suggestion provider proxies (reliable external sources)
        # DuckDuckGo: /suggest/ddg/?q=...
        location /suggest/ddg/ {
            resolver 127.0.0.11 1.1.1.1 8.8.8.8 ipv6=off;
            set $ddg_host duckduckgo.com;
            proxy_ssl_server_name on;
            proxy_pass https://$ddg_host/ac/;
            proxy_redirect off;
            proxy_set_header Host $ddg_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # Google (Firefox client): /suggest/google/?client=firefox&q=...
        location /suggest/google/ {
            resolver 127.0.0.11 1.1.1.1 8.8.8.8 ipv6=off;
            set $google_host suggestqueries.google.com;
            proxy_ssl_server_name on;
            proxy_pass https://$google_host/complete/search;
            proxy_redirect off;
            proxy_set_header Host $google_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        # Brave: /suggest/brave/?q=...
        location /suggest/brave/ {
            resolver 127.0.0.11 1.1.1.1 8.8.8.8 ipv6=off;
            set $brave_host search.brave.com;
            proxy_ssl_server_name on;
            proxy_pass https://$brave_host/api/suggest;
            proxy_redirect off;
            proxy_set_header Host $brave_host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Removed custom weather service proxy; we rely on Open-Meteo only.

        # Open-Meteo fallback proxy (no key)
        location /openmeteo/ {
            proxy_pass https://api.open-meteo.com/;
            proxy_redirect off;
            proxy_set_header Host api.open-meteo.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # AI API proxy (LM Studio/OpenAI/OpenRouter router)
        location ^~ /ai/ {
            proxy_pass http://host.docker.internal:3200/;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 1h;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Headers "Content-Type, Authorization";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                return 204;
            }
        }

        # Firecrawl API proxy (avoid CORS) on host port 3002
        location /firecrawl/ {
            proxy_pass http://host.docker.internal:3002/;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 1h;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Firecrawl (inline) proxy â€” separate path for optional override
        location /firecrawl-inline/ {
            proxy_pass http://host.docker.internal:3002/;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 1h;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
        }

        # Music backend proxy (HTTP + WebSocket) defaulting to host port 26538
        location ^~ /music/ {
            proxy_pass http://host.docker.internal:26538/;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Authorization $http_authorization;
            proxy_set_header Host host.docker.internal:26538;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            # Handle preflight for browsers that still preflight same-origin private network requests
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Access-Control-Request-Private-Network";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                add_header Access-Control-Allow-Private-Network "true";
                return 204;
            }
        }

        # STT proxy (Whisper ASR service in docker compose)
        location ^~ /stt/ {
            proxy_pass http://stt-api:9000/;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_cache off;
            proxy_read_timeout 1h;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            client_max_body_size 50m;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Headers "Content-Type, Authorization";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                return 204;
            }
        }

        # STT normalize endpoint: always transcribe, drop language=auto
        location = /stt/asr {
            proxy_pass http://stt-api:9000/asr?task=transcribe$stt_lang_param;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_cache off;
            proxy_read_timeout 1h;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Authorization $http_authorization;
            client_max_body_size 50m;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Headers "Content-Type, Authorization";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                return 204;
            }
        }

        # Icons API proxy (save + serve uploads)
        location ^~ /icons-api/ {
            proxy_pass http://icons-api:3100/;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_cache off;
            proxy_read_timeout 30s;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            if ($request_method = OPTIONS) {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Headers "Content-Type";
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
                return 204;
            }
        }

        # Image search proxy (OpenWeb Ninja, Yandex, TinEye via Node server)
        location ^~ /image-search/ {
            proxy_pass http://image-search-api:3300;
            proxy_http_version 1.1;
            proxy_buffering off;
            proxy_request_buffering off;
            proxy_cache off;
            proxy_read_timeout 60s;
            proxy_redirect off;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            client_max_body_size 50m;
        }

        # SPA fallback: serve index.html for client-side routes
        location / {
            try_files $uri $uri/ /index.html;
        }
    }
}
